<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Movie Database</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, select { padding: 6px; margin: 10px 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    tr:hover { background: #f9f9f9; }
    button {
  padding: 6px 12px;
  background-color: #007bff;
  border: none;
  color: white;
  border-radius: 4px;
  cursor: pointer;
}

button:hover {
  background-color: #0056b3;
}

  </style>
</head>
<body>
  <h1>My Movie Database</h1>

  <input type="text" id="searchInput" placeholder="Search by title or actor" />
  <select id="filterWatched">
    <option value="all">All</option>
    <option value="watched">Watched</option>
    <option value="unwatched">Unwatched</option>
  </select>

<h2>Add a New Movie</h2>
<input type="text" id="movieSearchInput" placeholder="Search TMDb for a movie title" />
<button id="searchMovieBtn">Search</button>

<div id="searchResults"></div>


  <table id="moviesTable">
    <thead>
      <tr>
        <th>Poster</th>
        <th>Title</th>
        <th>Year</th>
        <th>Length (min)</th>
        <th>Genre</th>
        <th>Actors</th>
        <th>Watched</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const BASE_URL = 'https://movie-database-6vdh.onrender.com';
    async function fetchMovies() {
      const res = await fetch('https://movie-database-6vdh.onrender.com/movies');
      const movies = await res.json();
      return movies;
    }

    function renderMovies(movies) {
  const tbody = document.querySelector('#moviesTable tbody');
  tbody.innerHTML = '';

  movies.forEach(movie => {
    const tr = document.createElement('tr');

    tr.innerHTML = `
    <td>
    <img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" alt="${movie.title} poster" style="height:100px;" />
  </td>
      <td>${movie.title}</td>
      <td>${movie.year || ''}</td>
      <td>${movie.length_minutes || ''}</td>
      <td>${movie.genre || ''}</td>
      <td>${movie.actors || ''}</td>
      <td>
        <input type="checkbox" data-id="${movie.id}" ${movie.watched ? 'checked' : ''}>
      </td>
    `;

    tbody.appendChild(tr);
  });

  // Add event listeners for checkboxes
  document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', async (e) => {
      const movieId = e.target.getAttribute('data-id');
      const watched = e.target.checked;

      try {
        await fetch(`https://movie-database-6vdh.onrender.com/movies/${movieId}/watched`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ watched })
        });
        // Optionally show a success message or update UI
      } catch (err) {
        alert('Error updating watched status');
        // Revert checkbox
        e.target.checked = !watched;
      }
    });
  });
}

async function applyFilters() {
  let movies = await fetchMovies();

  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const watchedFilter = document.getElementById('filterWatched').value;

  movies = movies.filter(movie => {
    const matchesSearch = movie.title.toLowerCase().includes(searchTerm) ||
      (movie.actors && movie.actors.toLowerCase().includes(searchTerm));

    let matchesWatched = true;
    if (watchedFilter === 'watched') matchesWatched = movie.watched === 1 || movie.watched === true;
    else if (watchedFilter === 'unwatched') matchesWatched = movie.watched === 0 || movie.watched === false;

    return matchesSearch && matchesWatched;
  });

  renderMovies(movies);
}


    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('filterWatched').addEventListener('change', applyFilters);

    document.getElementById('searchMovieBtn').addEventListener('click', async () => {
  const query = document.getElementById('movieSearchInput').value.trim();
  if (!query) return alert('Please enter a movie title to search.');

  const apiKey = 'c430d157063361f687656faf60867611'; // Replace with your TMDb API key
  const url = `https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(query)}`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '';

    if (data.results.length === 0) {
      resultsDiv.textContent = 'No movies found.';
      return;
    }

  data.results.slice(0, 5).forEach(movie => {
  const div = document.createElement('div');
  div.style.border = '1px solid #ccc';
  div.style.margin = '5px';
  div.style.padding = '5px';
  div.style.overflow = 'hidden'; // make sure container wraps floated content

const shortOverview = movie.overview.length > 100 ? movie.overview.slice(0, 100) + '...' : movie.overview;

  div.innerHTML = `
    <img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" alt="${movie.title} poster" style="float:left; margin-right:10px; width:80px;">
    <strong>${movie.title} (${movie.release_date ? movie.release_date.slice(0,4) : 'N/A'})</strong>
    <p>
    <span class="overview-short">${shortOverview}</span>
    <span class="overview-full" style="display:none;">${movie.overview}</span>
    <button class="toggle-overview-btn" style="margin-left:10px; font-size:0.9em;">Show more</button>
  </p>
    <button data-id="${movie.id}">Add</button>
  `;

  resultsDiv.appendChild(div);

  // After appending div to resultsDiv
const toggleBtn = div.querySelector('.toggle-overview-btn');
const shortText = div.querySelector('.overview-short');
const fullText = div.querySelector('.overview-full');

toggleBtn.addEventListener('click', () => {
  if (fullText.style.display === 'none') {
    fullText.style.display = 'inline';
    shortText.style.display = 'none';
    toggleBtn.textContent = 'Show less';
  } else {
    fullText.style.display = 'none';
    shortText.style.display = 'inline';
    toggleBtn.textContent = 'Show more';
  }
});


div.querySelector('button[data-id]').addEventListener('click', () => addMovieByTmdbId(movie.id));
});
  } catch (err) {
    alert('Error searching movies');
  }
});

async function addMovieByTmdbId(tmdbId) {
  try {
    const res = await fetch('https://movie-database-6vdh.onrender.com/movies', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tmdbId })
    });

    if (res.ok) {
      alert('Movie added!');
      applyFilters(); // Refresh movie list
      document.getElementById('searchResults').innerHTML = '';
      document.getElementById('movieSearchInput').value = '';
    } else {
      const text = await res.text();
      alert('Error adding movie: ' + text);
    }
  } catch (err) {
    alert('Error adding movie');
  }
}






    // Initial load
    applyFilters();
  </script>
</body>
</html>
